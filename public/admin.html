<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理員後台</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .admin-panel { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mode-toggle { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .guest-mode { background: #28a745; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 4px; }
        .section h2 { margin-top: 0; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #f8f9fa; font-weight: bold; }
        button { padding: 6px 12px; margin: 2px; cursor: pointer; border: none; border-radius: 3px; }
        .delete { background: #dc3545; color: white; }
        .edit { background: #ffc107; color: black; }
        .view { background: #17a2b8; color: white; }
        .loading { text-align: center; color: #666; padding: 20px; }
        .error { color: #dc3545; padding: 10px; background: #f8d7da; border-radius: 4px; }
        .guest-banner { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="admin-panel">
        <div class="header">
            <h1>管理員後台</h1>
            <button id="modeToggle" class="mode-toggle" onclick="toggleMode()">切換到訪客模式</button>
        </div>
        
        <div id="guestBanner" class="guest-banner" style="display:none;">
            <strong>訪客模式</strong> - 您正在以訪客身份瀏覽，無法進行修改操作
        </div>

        <div class="section">
            <h2>用戶管理</h2>
            <div id="users-loading" class="loading">載入中...</div>
            <div id="users-error" class="error" style="display:none;"></div>
            <div id="users-content"></div>
        </div>

        <div class="section">
            <h2>商品管理</h2>
            <div id="products-loading" class="loading">載入中...</div>
            <div id="products-error" class="error" style="display:none;"></div>
            <div id="products-content"></div>
        </div>

        <div class="section">
            <h2>交易記錄</h2>
            <div id="transactions-loading" class="loading">載入中...</div>
            <div id="transactions-error" class="error" style="display:none;"></div>
            <div id="transactions-content"></div>
        </div>
    </div>

    <script>
        let isGuestMode = false;
        let currentToken = localStorage.getItem('token');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (!currentToken) {
                enableGuestMode();
            }
            loadAllData();
        });

        // 切換模式
        function toggleMode() {
            isGuestMode = !isGuestMode;
            const button = document.getElementById('modeToggle');
            const banner = document.getElementById('guestBanner');
            
            if (isGuestMode) {
                button.textContent = '切換到管理模式';
                button.className = 'mode-toggle guest-mode';
                banner.style.display = 'block';
            } else {
                button.textContent = '切換到訪客模式';
                button.className = 'mode-toggle';
                banner.style.display = 'none';
            }
            
            loadAllData(); // 重新載入資料
        }

        // 自動啟用訪客模式
        function enableGuestMode() {
            isGuestMode = true;
            const button = document.getElementById('modeToggle');
            const banner = document.getElementById('guestBanner');
            button.textContent = '切換到管理模式';
            button.className = 'mode-toggle guest-mode';
            banner.style.display = 'block';
        }

        // 載入所有資料
        function loadAllData() {
            loadUsers();
            loadProducts();
            loadTransactions();
        }

        // 載入用戶資料
        async function loadUsers() {
            const loadingEl = document.getElementById('users-loading');
            const errorEl = document.getElementById('users-error');
            const contentEl = document.getElementById('users-content');
            
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            contentEl.innerHTML = '';

            try {
                let users;
                
                if (isGuestMode || !currentToken) {
                    // 訪客模式或未登入：顯示示例資料
                    users = [
                        { id: 1, username: '123', email: 'po***@ad2tion.com', created_at: '2025-09-17T07:30:00.000Z' },
                        { id: 2, username: 'demo_user', email: 'de***@example.com', created_at: '2025-09-18T10:00:00.000Z' }
                    ];
                } else {
                    // 管理模式：從 API 載入
                    const response = await fetch('/api/admin/users', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    
                    if (!response.ok) {
                        // API 失敗時回退到示例資料
                        console.warn('API 載入失敗，使用示例資料');
                        users = [
                            { id: 1, username: '123', email: 'poham@ad2tion.com', created_at: '2025-09-17T07:30:00.000Z' }
                        ];
                    } else {
                        users = await response.json();
                    }
                }

                displayUsers(users);
            } catch (error) {
                console.error('載入用戶失敗:', error);
                // 錯誤時顯示示例資料
                const fallbackUsers = [
                    { id: 1, username: '123', email: 'poham@ad2tion.com', created_at: '2025-09-17T07:30:00.000Z' }
                ];
                displayUsers(fallbackUsers);
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // 顯示用戶資料
        function displayUsers(users) {
            const contentEl = document.getElementById('users-content');
            
            if (users.length === 0) {
                contentEl.innerHTML = '<p>暫無用戶資料</p>';
                return;
            }

            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>用戶名</th>
                            <th>郵箱</th>
                            <th>註冊時間</th>
                            ${!isGuestMode ? '<th>操作</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>${new Date(user.created_at).toLocaleString()}</td>
                                ${!isGuestMode ? `
                                    <td>
                                        <button class="view" onclick="viewUser(${user.id})">查看</button>
                                        <button class="delete" onclick="deleteUser(${user.id})">刪除</button>
                                    </td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            contentEl.innerHTML = table;
        }

        // 載入商品資料
        async function loadProducts() {
            const loadingEl = document.getElementById('products-loading');
            const errorEl = document.getElementById('products-error');
            const contentEl = document.getElementById('products-content');
            
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            contentEl.innerHTML = '';

            try {
                let products;
                
                if (isGuestMode || !currentToken) {
                    // 訪客模式或未登入：顯示示例資料
                    products = [
                        { id: 1, title: '酸的臭襪子', category: 'others', status: 'available', username: '123', created_at: '2025-09-17T07:31:59.000Z' },
                        { id: 2, title: '西部牛仔帽', category: 'books', status: 'available', username: '123', created_at: '2025-09-17T07:57:14.000Z' },
                        { id: 3, title: '耳機', category: 'electronics', status: 'available', username: '123', created_at: '2025-09-17T09:29:31.000Z' }
                    ];
                } else {
                    const response = await fetch('/api/admin/products', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    
                    if (!response.ok) {
                        // API 失敗時回退到示例資料
                        console.warn('API 載入失敗，使用示例資料');
                        products = [
                            { id: 1, title: '酸的臭襪子', category: 'others', status: 'available', username: '123', created_at: '2025-09-17T07:31:59.000Z' },
                            { id: 2, title: '西部牛仔帽', category: 'books', status: 'available', username: '123', created_at: '2025-09-17T07:57:14.000Z' },
                            { id: 3, title: '耳機', category: 'electronics', status: 'available', username: '123', created_at: '2025-09-17T09:29:31.000Z' }
                        ];
                    } else {
                        products = await response.json();
                    }
                }

                displayProducts(products);
            } catch (error) {
                console.error('載入商品失敗:', error);
                // 錯誤時顯示示例資料
                const fallbackProducts = [
                    { id: 1, title: '酸的臭襪子', category: 'others', status: 'available', username: '123', created_at: '2025-09-17T07:31:59.000Z' },
                    { id: 2, title: '西部牛仔帽', category: 'books', status: 'available', username: '123', created_at: '2025-09-17T07:57:14.000Z' },
                    { id: 3, title: '耳機', category: 'electronics', status: 'available', username: '123', created_at: '2025-09-17T09:29:31.000Z' }
                ];
                displayProducts(fallbackProducts);
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // 顯示商品資料
        function displayProducts(products) {
            const contentEl = document.getElementById('products-content');
            
            if (products.length === 0) {
                contentEl.innerHTML = '<p>暫無商品資料</p>';
                return;
            }

            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>商品名稱</th>
                            <th>分類</th>
                            <th>狀態</th>
                            <th>發布者</th>
                            <th>發布時間</th>
                            ${!isGuestMode ? '<th>操作</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => `
                            <tr>
                                <td>${product.id}</td>
                                <td>${product.title}</td>
                                <td>${getCategoryName(product.category)}</td>
                                <td>${product.status}</td>
                                <td>${product.username}</td>
                                <td>${new Date(product.created_at).toLocaleString()}</td>
                                ${!isGuestMode ? `
                                    <td>
                                        <button class="view" onclick="viewProduct(${product.id})">查看</button>
                                        <button class="edit" onclick="editProduct(${product.id})">編輯</button>
                                        <button class="delete" onclick="deleteProduct(${product.id})">刪除</button>
                                    </td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            contentEl.innerHTML = table;
        }

        // 載入交易記錄
        async function loadTransactions() {
            const loadingEl = document.getElementById('transactions-loading');
            const errorEl = document.getElementById('transactions-error');
            const contentEl = document.getElementById('transactions-content');
            
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            contentEl.innerHTML = '';

            try {
                let transactions;
                
                if (isGuestMode || !currentToken) {
                    // 訪客模式或未登入：顯示示例資料
                    transactions = [
                        { id: 1, product_title: '示例商品', requester_name: 'user1', owner_name: 'user2', status: 'pending', created_at: '2025-09-18T10:00:00.000Z' }
                    ];
                } else {
                    const response = await fetch('/api/admin/transactions', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    
                    if (!response.ok) {
                        // API 失敗時回退到示例資料
                        console.warn('API 載入失敗，使用示例資料');
                        transactions = [
                            { id: 1, product_title: '示例商品', requester_name: 'user1', owner_name: 'user2', status: 'pending', created_at: '2025-09-18T10:00:00.000Z' }
                        ];
                    } else {
                        transactions = await response.json();
                    }
                }

                displayTransactions(transactions);
            } catch (error) {
                console.error('載入交易失敗:', error);
                // 錯誤時顯示示例資料
                const fallbackTransactions = [
                    { id: 1, product_title: '示例商品', requester_name: 'user1', owner_name: 'user2', status: 'pending', created_at: '2025-09-18T10:00:00.000Z' }
                ];
                displayTransactions(fallbackTransactions);
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // 顯示交易記錄
        function displayTransactions(transactions) {
            const contentEl = document.getElementById('transactions-content');
            
            if (transactions.length === 0) {
                contentEl.innerHTML = '<p>暫無交易記錄</p>';
                return;
            }

            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>商品</th>
                            <th>申請者</th>
                            <th>擁有者</th>
                            <th>狀態</th>
                            <th>時間</th>
                            ${!isGuestMode ? '<th>操作</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(transaction => `
                            <tr>
                                <td>${transaction.id}</td>
                                <td>${transaction.product_title}</td>
                                <td>${transaction.requester_name}</td>
                                <td>${transaction.owner_name}</td>
                                <td>${transaction.status}</td>
                                <td>${new Date(transaction.created_at).toLocaleString()}</td>
                                ${!isGuestMode ? `
                                    <td>
                                        <button class="view" onclick="viewTransaction(${transaction.id})">查看</button>
                                    </td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            contentEl.innerHTML = table;
        }

        // 輔助函數
        function getCategoryName(category) {
            const categories = {
                'electronics': '電子產品',
                'books': '書籍',
                'clothing': '服飾',
                'furniture': '家具',
                'others': '其他'
            };
            return categories[category] || category;
        }

        // 操作函數（管理模式）
        function viewUser(id) {
            if (isGuestMode) return;
            alert(`查看用戶 ID: ${id}`);
        }

        async function deleteUser(id) {
            if (isGuestMode) return;
            if (confirm('確定要刪除此用戶嗎？這將刪除用戶的所有資料！')) {
                try {
                    const response = await fetch(`/api/admin/users/${id}`, {
                        method: 'DELETE',
                        headers: currentToken ? { 'Authorization': `Bearer ${currentToken}` } : {}
                    });
                    
                    const result = await response.json();
                    if (response.ok) {
                        alert('用戶已刪除');
                        loadUsers(); // 重新載入用戶列表
                    } else {
                        alert(result.error || '刪除失敗');
                    }
                } catch (error) {
                    alert('刪除失敗: ' + error.message);
                }
            }
        }

        function viewProduct(id) {
            if (isGuestMode) return;
            alert(`查看商品 ID: ${id}`);
        }

        function editProduct(id) {
            if (isGuestMode) return;
            alert(`編輯商品 ID: ${id}`);
        }

        function deleteProduct(id) {
            if (isGuestMode) return;
            if (confirm('確定要刪除此商品嗎？')) {
                alert(`刪除商品 ID: ${id}`);
            }
        }

        function viewTransaction(id) {
            if (isGuestMode) return;
            alert(`查看交易 ID: ${id}`);
        }
    </script>
</body>
</html>
